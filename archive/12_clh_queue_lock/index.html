<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=icon type=image/ico href=https://caffcen.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://caffcen.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://caffcen.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://caffcen.github.io/android-chrome-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https://caffcen.github.io/apple-touch-icon.png><meta name=description content><title>æ·±å…¥ç†è§£ CLH Queue Lock | Lihang Liu's Homepage</title><link rel=canonical href=https://caffcen.github.io/archive/12_clh_queue_lock/><meta property="og:url" content="https://caffcen.github.io/archive/12_clh_queue_lock/"><meta property="og:site_name" content="Lihang Liu's Homepage"><meta property="og:title" content="æ·±å…¥ç†è§£ CLH Queue Lock"><meta property="og:description" content="è¯¦è§£CLHé˜Ÿåˆ—é”çš„è®¾è®¡åŸç†ã€å®ç°æœºåˆ¶åŠå…¶åœ¨Javaå¹¶å‘ç¼–ç¨‹ä¸­çš„åº”ç”¨ï¼Œä¸ºç†è§£AQSå’ŒJUCåŒæ­¥åŸè¯­å¥ å®šåŸºç¡€"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="archive"><meta property="article:published_time" content="2023-04-09T16:04:25+08:00"><meta property="article:modified_time" content="2025-11-23T14:50:26-05:00"><link rel=stylesheet href=/assets/combined.min.57df9e7d692553f966cff4593ede6b53efb74da234876bacffeac774bd572e53.css media=all></head><body class=auto><div class=content><header><div class=header><h1 class=header-title><a href=https://caffcen.github.io/>Lihang Liu's Homepage</a></h1><div class=header-menu><p class=small><a href=/>/Home</a></p><p class=small><a href=/blog/>/Blog</a></p><p class=small><a href=/archive/>/Archive</a></p></div></div></header><main class=main><div class=breadcrumbs><a href=/>Home</a><span class=breadcrumbs-separator>/</span><a href=/archive/>Archive</a><span class=breadcrumbs-separator>/</span>
<a href=/archive/12_clh_queue_lock/>æ·±å…¥ç†è§£ CLH Queue Lock</a></div><div><article><header class=single-intro-container><h1 class=single-title>æ·±å…¥ç†è§£ CLH Queue Lock</h1><p class=single-summary>è¯¦è§£CLHé˜Ÿåˆ—é”çš„è®¾è®¡åŸç†ã€å®ç°æœºåˆ¶åŠå…¶åœ¨Javaå¹¶å‘ç¼–ç¨‹ä¸­çš„åº”ç”¨ï¼Œä¸ºç†è§£AQSå’ŒJUCåŒæ­¥åŸè¯­å¥ å®šåŸºç¡€</p><div class=single-subsummary><div><p class=single-date><time datetime=2023-04-09T16:04:25+08:00>April 9, 2023</time></p></div></div></header><div class=single-content><p>JUC åŒ…ä¸­çš„å¾ˆå¤šåŒæ­¥åŸè¯­æ˜¯åŸºäº AbstractQueuedSynchronizerï¼ˆä»¥ä¸‹ç®€ç§° AQSï¼‰ å®ç°çš„ï¼Œè€Œ AQS çš„å®ç°åˆæ˜¯åŸºäº CLH é˜Ÿåˆ—é”ï¼ˆCLH queued lockï¼‰ï¼Œå› æ­¤å­¦ä¹ å¹¶ç†è§£ CLH é˜Ÿåˆ—é”å¯¹æˆ‘ä»¬å­¦ä¹  JUC ä¸­çš„å„ç§åŒæ­¥åŸè¯­éå¸¸æœ‰å¸®åŠ©ã€‚æœ¬æ–‡å°†é˜è¿° CLH é˜Ÿåˆ—é”çš„å®ç°å’ŒåŸç†ã€‚</p><h1 class=heading id=clh-queue-lock>CLH Queue Lock
<a class=anchor href=#clh-queue-lock>#</a></h1><p>CLH é˜Ÿåˆ—é”æ˜¯ç”± Craig, Landin, Hagersten ä¸‰ä½å¤§ä½¬æå‡ºçš„ï¼Œå› æ­¤è¢«ç§°ä¸º CLH é˜Ÿåˆ—é”ï¼Œå®ƒæ˜¯ä¸€ç§è‡ªæ—‹å…¬å¹³é”ï¼ŒåŸºäºè™šé“¾è¡¨å®ç°ï¼ˆvirtual linked listï¼‰ã€‚</p><p>ã€ŠThe Art of Multiprocessor Programmingã€‹7.5.2 èŠ‚ç»™å‡ºäº† CLH å¯èƒ½çš„ä¸€ç§ Java è¯­è¨€å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic;text-decoration:underline>public</span> <span style=font-weight:700;font-style:italic;text-decoration:underline>class</span> <span style=color:#666;font-weight:700;font-style:italic>CLHLock</span> <span style=font-weight:700;font-style:italic;text-decoration:underline>implements</span> Lock {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    AtomicReference&lt;QNode&gt; tail;
</span></span><span style=display:flex><span>    ThreadLocal&lt;QNode&gt; myPred;
</span></span><span style=display:flex><span>    ThreadLocal&lt;QNode&gt; myNode;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;font-style:italic;text-decoration:underline>public</span> <span style=color:#666;font-weight:700;font-style:italic>CLHLock</span>() {
</span></span><span style=display:flex><span>        tail = <span style=font-weight:700;text-decoration:underline>new</span> AtomicReference&lt;QNode&gt;(<span style=font-weight:700;text-decoration:underline>new</span> QNode());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        myNode = <span style=font-weight:700;text-decoration:underline>new</span> ThreadLocal&lt;QNode&gt;() {
</span></span><span style=display:flex><span>            <span style=font-weight:700;font-style:italic;text-decoration:underline>protected</span> QNode <span style=color:#666;font-weight:700;font-style:italic>initialValue</span>() {
</span></span><span style=display:flex><span>                <span style=font-weight:700;text-decoration:underline>return</span> <span style=font-weight:700;text-decoration:underline>new</span> QNode();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        myPred = <span style=font-weight:700;text-decoration:underline>new</span> ThreadLocal&lt;QNode&gt;() {
</span></span><span style=display:flex><span>            <span style=font-weight:700;font-style:italic;text-decoration:underline>protected</span> QNode <span style=color:#666;font-weight:700;font-style:italic>initialValue</span>() {
</span></span><span style=display:flex><span>                <span style=font-weight:700;text-decoration:underline>return</span> <span style=font-weight:700;text-decoration:underline>null</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;font-style:italic;text-decoration:underline>public</span> <span style=font-weight:700;text-decoration:underline>void</span> <span style=color:#666;font-weight:700;font-style:italic>lock</span>() {
</span></span><span style=display:flex><span>        QNode qnode = myNode.get();
</span></span><span style=display:flex><span>        qnode.locked = <span style=font-weight:700;text-decoration:underline>true</span>;
</span></span><span style=display:flex><span>        QNode pred = tail.getAndSet(qnode);
</span></span><span style=display:flex><span>        myPred.set(pred);
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>while</span> (pred.locked) {
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;font-style:italic;text-decoration:underline>public</span> <span style=font-weight:700;text-decoration:underline>void</span> <span style=color:#666;font-weight:700;font-style:italic>unlock</span>() {
</span></span><span style=display:flex><span>        QNode qnode = myNode.get();
</span></span><span style=display:flex><span>        qnode.locked = <span style=font-weight:700;text-decoration:underline>false</span>;
</span></span><span style=display:flex><span>        myNode.set(myPred.get());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;font-style:italic;text-decoration:underline>class</span> <span style=color:#666;font-weight:700;font-style:italic>QNode</span> {
</span></span><span style=display:flex><span>        <span style=font-weight:700;font-style:italic;text-decoration:underline>volatile</span> <span style=font-weight:700;text-decoration:underline>boolean</span> locked = <span style=font-weight:700;text-decoration:underline>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ¥ä¸‹æ¥å°†ä¼šå¯¹æºç ä»¥åŠå…¶ä¸­å„ä¸ªå…³é”®æŠ€æœ¯è¿›è¡Œåˆ†æã€‚</p><h2 class=heading id=æ•°æ®ç»“æ„>æ•°æ®ç»“æ„
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84>#</a></h2><h3 class=heading id=qnode>QNode
<a class=anchor href=#qnode>#</a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic;text-decoration:underline>class</span> <span style=color:#666;font-weight:700;font-style:italic>QNode</span> {
</span></span><span style=display:flex><span>    <span style=font-weight:700;font-style:italic;text-decoration:underline>volatile</span> <span style=font-weight:700;text-decoration:underline>boolean</span> locked = <span style=font-weight:700;text-decoration:underline>false</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>QNode</code> è®°å½•ä¸€ä¸ªçº¿ç¨‹çš„åŒæ­¥çŠ¶æ€ï¼Œå®ƒåªæœ‰ä¸€ä¸ªå®ä¾‹å­—æ®µ <code>locked</code> ï¼Œå…¶å«ä¹‰ä¸ºï¼š</p><ul><li><code>true</code> ï¼šè¡¨ç¤ºè¯¥çº¿ç¨‹è¦ä¹ˆå·²ç»æ‹¿åˆ°äº†é”ï¼Œè¦ä¹ˆç­‰å¾…è·å–é”</li><li><code>false</code> ï¼šè¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»é‡Šæ”¾äº†é”ã€‚</li></ul><h3 class=heading id=virtual-linked-list>Virtual Linked List
<a class=anchor href=#virtual-linked-list>#</a></h3><p><code>CLHLock</code> ç±»ä¸­æœ‰ä¸‰ä¸ªå®ä¾‹å­—æ®µï¼Œå…±åŒæ„æˆäº† CLH é˜Ÿåˆ—é”çš„è™šé˜Ÿåˆ—ç»“æ„ï¼š</p><ol><li><code>AtomicReference&lt;QNode> tail</code> ï¼šæŒ‡å‘æœ€ååŠ å…¥è™šé˜Ÿåˆ—çš„çº¿ç¨‹èŠ‚ç‚¹</li><li><code>ThreadLocal&lt;QNode> myPred</code> ï¼šæ¯ä¸ªçº¿ç¨‹ç‹¬æœ‰ï¼ŒæŒ‡å‘è¯¥çº¿ç¨‹çš„å‰ç»§èŠ‚ç‚¹çš„ <code>QNode</code></li><li><code>ThreadLocal&lt;QNode> myNode</code> ï¼šæ¯ä¸ªçº¿ç¨‹ç‹¬æœ‰ï¼ŒæŒ‡å‘çº¿ç¨‹è‡ªå·±çš„ <code>QNode</code></li></ol><p><code>tail</code> èŠ‚ç‚¹æ˜¯å§‹ç»ˆæŒ‡å‘è™šé˜Ÿåˆ—çš„å°¾ç»“ç‚¹ï¼Œå³æœ€ååŠ å…¥é˜Ÿåˆ—çš„çº¿ç¨‹èŠ‚ç‚¹ã€‚å› å…¶æ˜¯ <code>AtomicReference</code> ç±»å‹ï¼Œå› æ­¤å¯¹å…¶çš„æ“ä½œéƒ½å¯ä»¥ä¿è¯æ˜¯åŸå­æ€§çš„ï¼Œä¸ä¼šé€ æˆçº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ã€‚</p><p>è€Œä¹‹æ‰€ä»¥ç§° CLH é˜Ÿåˆ—é”çš„æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªè™šé˜Ÿåˆ—ï¼Œæ˜¯å› ä¸ºæ¯ä¸ªçº¿ç¨‹åªèƒ½é€šè¿‡ <code>prev</code> èŠ‚ç‚¹è®¿é—®åˆ°å®ƒçš„å‰ç»§èŠ‚ç‚¹ï¼Œé“¾è¡¨ç»“æ„å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ã€éšå¼ã€çš„ã€‚</p><blockquote><p>We use the term â€œvirtualâ€ because the list is implicit: Each thread refers to its predecessor through a thread-local pred variable.</p></blockquote><p>CLH é˜Ÿåˆ—æ˜¯æ ¹æ®çº¿ç¨‹è¯·æ±‚é”çš„é¡ºåºæ¥è¿›è¡Œæ’åˆ—çš„ï¼Œå› æ­¤æ˜¯ First-in-first-out çš„ï¼Œæ»¡è¶³å…¬å¹³é”çš„å®šä¹‰ã€‚</p><h2 class=heading id=åŠ é”>åŠ é”
<a class=anchor href=#%e5%8a%a0%e9%94%81>#</a></h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic;text-decoration:underline>public</span> <span style=font-weight:700;text-decoration:underline>void</span> <span style=color:#666;font-weight:700;font-style:italic>lock</span>() {
</span></span><span style=display:flex><span>	<span style=color:#888;font-style:italic>// è·å–å½“å‰çº¿ç¨‹çš„ QNode</span>
</span></span><span style=display:flex><span>    QNode qnode = myNode.get();
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// å°† myNode.locked ç½®ä¸º trueï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æƒ³è¦è·å–é”</span>
</span></span><span style=display:flex><span>    qnode.locked = <span style=font-weight:700;text-decoration:underline>true</span>;
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// é€šè¿‡ tail è·å–é˜Ÿåˆ—æœ«å°¾çš„çº¿ç¨‹ QNode</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// å¹¶ä¸”æ›´æ–° tail èŠ‚ç‚¹æŒ‡å‘å½“å‰çº¿ç¨‹ï¼ŒCAS æ“ä½œä¿è¯åŸå­æ€§</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// ç°åœ¨å½“å‰çº¿ç¨‹æ’åˆ°äº†é˜Ÿåˆ—çš„æœ«å°¾</span>
</span></span><span style=display:flex><span>    QNode pred = tail.getAndSet(qnode);
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// è®¾ç½®å½“å‰çº¿ç¨‹çš„å‰ç»§èŠ‚ç‚¹ myPred</span>
</span></span><span style=display:flex><span>    myPred.set(pred);
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// åœ¨ pred ä¸Šå¿™ç­‰å¾…ï¼Œç›´åˆ°å‰ç»§èŠ‚ç‚¹å°†å…¶ locked æ›´æ–°ä¸º flase</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>while</span> (pred.locked) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸€ä¸ªçº¿ç¨‹è·å–é”çš„æ­¥éª¤å¯ä»¥æ€»ç»“ä¸ºï¼š</p><ol><li>å°†è‡ªå·±çš„ <code>QNode</code> çŠ¶æ€ç½®ä¸º <code>true</code> ï¼Œè¡¨ç¤ºè‡ªå·±æƒ³è¦è·å–é”ã€‚</li><li>å°†è‡ªå·±åŠ å…¥åˆ°è™šé˜Ÿåˆ—çš„æœ«å°¾ï¼ˆå³è®© <code>tail</code> æŒ‡å‘è‡ªå·±çš„ <code>QNode</code> ï¼‰ï¼ŒåŒæ—¶å¾—åˆ°è‡ªå·±çš„å‰ç»§èŠ‚ç‚¹çš„ <code>QNode</code> ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œç”± <code>AtomicReference</code> ç±»å‹ä¿è¯ã€‚</li><li>åœ¨å‰ç»§èŠ‚ç‚¹ <code>myPred</code> çš„ <code>QNode</code> ä¸Šè¿›è¡Œå¿™ç­‰å¾…ï¼Œç›´åˆ°å‰ç»§èŠ‚ç‚¹é‡Šæ”¾é”ä¸ºæ­¢ã€‚</li></ol><h2 class=heading id=è§£é”>è§£é”
<a class=anchor href=#%e8%a7%a3%e9%94%81>#</a></h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic;text-decoration:underline>public</span> <span style=font-weight:700;text-decoration:underline>void</span> <span style=color:#666;font-weight:700;font-style:italic>unlock</span>() {
</span></span><span style=display:flex><span>	<span style=color:#888;font-style:italic>// è·å–å½“å‰çº¿ç¨‹ QNode</span>
</span></span><span style=display:flex><span>    QNode qnode = myNode.get();
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// å°†å…¶ç½®ä¸º falseï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹ç¦»å¼€ä¸´ç•ŒåŒºï¼Œå¹¶é‡Šæ”¾é”</span>
</span></span><span style=display:flex><span>    qnode.locked = <span style=font-weight:700;text-decoration:underline>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// å¾ªç¯åˆ©ç”¨ QNodeï¼Œä¸”é˜²æ­¢è¯¥çº¿ç¨‹ä¸‹æ¬¡åŠ é”æ—¶å‘ç”Ÿæ­»é”</span>
</span></span><span style=display:flex><span>    myNode.set(myPred.get());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>çº¿ç¨‹è§£é”çš„æ­¥éª¤å¯ä»¥æ€»ç»“ä¸ºï¼š</p><ol><li>è·å–å½“å‰çº¿ç¨‹çš„ <code>QNode</code></li><li>å°†å½“å‰çº¿ç¨‹çš„ <code>QNode</code> çŠ¶æ€ç½®ä¸º <code>false</code> ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹å·²ç»å¤„ç†å®Œä¸´ç•ŒåŒºçš„å·¥ä½œï¼Œé‡Šæ”¾é”</li><li>æ›´æ–° <code>myNode</code> å¼•ç”¨ï¼Œä½¿å…¶æŒ‡å‘ä¸€ä¸ªæ–°çš„ <code>QNode</code> å¯¹è±¡ï¼Œé˜²æ­¢æ­»é”ã€‚</li></ol><h3 class=heading id=æ­»é”çš„å¯èƒ½æ€§ä»¥åŠ-qnode-çš„å›æ”¶åˆ©ç”¨>æ­»é”çš„å¯èƒ½æ€§ä»¥åŠ QNode çš„å›æ”¶åˆ©ç”¨
<a class=anchor href=#%e6%ad%bb%e9%94%81%e7%9a%84%e5%8f%af%e8%83%bd%e6%80%a7%e4%bb%a5%e5%8f%8a-qnode-%e7%9a%84%e5%9b%9e%e6%94%b6%e5%88%a9%e7%94%a8>#</a></h3><p>å¯èƒ½æœ‰è¯»è€…ä¼šå¥‡æ€ªè¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦æ›´æ–° <code>myNode</code> å¼•ç”¨ï¼Œèƒ½ä¸èƒ½ä¸æ›´æ–° <code>myNode</code> å¼•ç”¨ï¼Œç›´æ¥ä»æ–¹æ³•è°ƒç”¨ä¸­è¿”å›å‘¢ï¼Ÿ</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic;text-decoration:underline>public</span> <span style=font-weight:700;text-decoration:underline>void</span> <span style=color:#666;font-weight:700;font-style:italic>unlock</span>() {
</span></span><span style=display:flex><span>    QNode qnode = myNode.get();
</span></span><span style=display:flex><span>    qnode.locked = <span style=font-weight:700;text-decoration:underline>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// ä¸æ›´æ–° myNode å¼•ç”¨ç›´æ¥è¿”å›</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// myNode.set(myPred.get());</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¦‚æœä¸æ›´æ–° <code>myNode</code> å¯¹è±¡ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå‡ºç°å¦‚ä¸‹çš„æƒ…å†µï¼š</p><p><figure><div class=img-container style=--w:2036;--h:908><img loading=lazy alt src=/archive/12_clh_queue_lock/Pasted%20image%2020230409152218.png width=2036 height=908></div></figure></p><p>å‡è®¾æ•´ä¸ª CLH é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒèƒ½å¤Ÿç«‹åˆ»è·å¾—é”ï¼ˆå› ä¸ºæ²¡æœ‰å‰ç»§èŠ‚ç‚¹æŒæœ‰é”ï¼‰å¹¶è¿›å…¥ä¸´ç•ŒåŒºã€‚å®ƒåœ¨æ‰§è¡Œå®Œä¸´ç•ŒåŒºå·¥ä½œåé‡Šæ”¾äº†é”ï¼Œå°†è‡ªå·±çš„ <code>QNode</code> ç½®ä¸º <code>flase</code> ï¼Œé‚£ä¹ˆå°†å˜æˆä¸‹å›¾çš„æƒ…å†µï¼š</p><p><figure><div class=img-container style=--w:1962;--h:866><img loading=lazy alt src=/archive/12_clh_queue_lock/Pasted%20image%2020230409152556.png width=1962 height=866></div></figure></p><p>ä¹‹åï¼Œè¯¥çº¿ç¨‹ç«‹åˆ»å†æ¬¡å°è¯•è·å–é”ï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒCLH é˜Ÿåˆ—çš„æƒ…å†µå’Œä¸Šå›¾æ˜¯ä¸€è‡´çš„ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨è§£é”æ—¶æ²¡æœ‰æ›´æ–° <code>myNode</code> å¼•ç”¨ï¼Œé‚£ä¹ˆ <code>tail</code> èŠ‚ç‚¹å’Œè¯¥çº¿ç¨‹çš„ <code>myNode</code> èŠ‚ç‚¹æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå†…å­˜å¯¹è±¡ã€‚é‚£ä¹ˆè€ƒè™‘è¯¥çº¿ç¨‹é‡æ–°å°è¯•åŠ é”æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic;text-decoration:underline>public</span> <span style=font-weight:700;text-decoration:underline>void</span> <span style=color:#666;font-weight:700;font-style:italic>lock</span>() {
</span></span><span style=display:flex><span>	<span style=color:#888;font-style:italic>// qnode å³ä¸ºä¸Šæ¬¡åŠ é”ã€è§£é”ä¸­ä½¿ç”¨çš„ QNode æ•°æ®ç»“æ„</span>
</span></span><span style=display:flex><span>    QNode qnode = myNode.get();
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// å°† myNode.locked ç½®ä¸º true</span>
</span></span><span style=display:flex><span>    qnode.locked = <span style=font-weight:700;text-decoration:underline>true</span>;
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// é€šè¿‡ tail è·å–é˜Ÿåˆ—æœ«å°¾çš„çº¿ç¨‹ QNodeï¼Œtail æ­¤æ—¶æŒ‡å‘çš„å¯¹è±¡æ—¢ä¸ºè¯¥çº¿ç¨‹è‡ªå·±çš„ myNode</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// ä¹Ÿå°±æ˜¯ä¸Šä¸Šæ¡è¯­å¥ QNode qnode = myNode.get(); æ‹¿åˆ°çš„ QNode å¼•ç”¨</span>
</span></span><span style=display:flex><span>    QNode pred = tail.getAndSet(qnode);
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// è®¾ç½®å½“å‰çº¿ç¨‹çš„å‰ç»§èŠ‚ç‚¹ myPredï¼Œè¿™ä¸ªæ—¶å€™ myPred æŒ‡å‘äº† myNode</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// ä¹Ÿå°±æ˜¯è¯´è¯¥çº¿ç¨‹çš„å‰ç»§çº¿ç¨‹æ˜¯è‡ªå·±ï¼Œæ˜æ˜¾æ˜¯é”™è¯¯çš„</span>
</span></span><span style=display:flex><span>    myPred.set(pred);
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// pred.locked == myNode.locked &amp;&amp; myNode.locked == trueï¼Œæ­»é”</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>while</span> (pred.locked) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é€šè¿‡æ³¨é‡Šå¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼Œå› ä¸º <code>tail</code> æŒ‡å‘äº†æƒ³è¦é‡æ–°è·å–é”çš„è¿™æ¡çº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹çš„ <code>myNode</code> å’Œ <code>myPred</code> å°†æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œæœ€ç»ˆå°†æ°¸è¿œå¿™ç­‰å¾…ä¸‹å»ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åœ¨è§£é”æ—¶æ›´æ–° <code>myNode</code> çš„åŸå› ï¼Œè¿™æ˜¯ä¸ºäº†è®©åŒä¸€ä¸ªçº¿ç¨‹å†æ¬¡åŠ é”æ—¶ä¸å‘ç”Ÿæ­»é”è€Œå¿…è¦çš„ä¸€ä¸ªæ“ä½œã€‚</p><p>è€Œã€ŠThe Art of Multiprocessor Programmingã€‹çš„å®ç°ä¸­æ˜¯å°† <code>myPred</code> ç›´æ¥èµ‹å€¼ç»™äº† <code>myNode</code> ï¼Œè¿™æ˜¯å› ä¸ºå‰ç»§èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹å·²ç»ç¦»å¼€äº†ä¸´ç•ŒåŒºï¼Œè‡ªç„¶å®ƒçš„ <code>QNode</code> å°±ä¸ä¼šå†è¢«ä½¿ç”¨äº†ï¼Œè¿™é‡Œå¾ªç¯ä½¿ç”¨äº†å†…å­˜ä¸­çš„å¯¹è±¡ã€‚å…¶å®ä¹Ÿå¯ä»¥é‡æ–°å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„ <code>QNode</code> å¹¶èµ‹å€¼ç»™ <code>myNode</code> ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ã€ŠThe Art of Multiprocessor Programmingã€‹çš„ä¸€æ¡è„šæ³¨è¯´æ˜äº†è¿™ä¸€ç‚¹ï¼š</p><blockquote><p>There is no need to reuse nodes in garbage-collected languages such as Java or C#, but reuse would be needed in languages such as C++ or C.</p></blockquote><h2 class=heading id=æ€»ç»“>æ€»ç»“
<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h2><p>CLH é˜Ÿåˆ—é”é€šè¿‡ä¸€ä¸ªè™šé˜Ÿåˆ—æ¥ç»´æŠ¤æƒ³è¦è·å–é”çš„çº¿ç¨‹ï¼Œæ¯å½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è·å–é”æ—¶ï¼ŒCLH å°†å…¶æ”¾åˆ°é˜Ÿåˆ—çš„æœ«å°¾ï¼Œå¹¶è®©å…¶è·å¾—å®ƒçš„å‰ç»§èŠ‚ç‚¹ï¼ˆå³æ’åœ¨å®ƒå‰é¢çš„çº¿ç¨‹ï¼‰çš„ <code>QNode</code> å¼•ç”¨ã€‚ä¸€ä¸ªçº¿ç¨‹é€šè¿‡åœ¨å®ƒçš„å‰ç»§èŠ‚ç‚¹çš„ <code>QNode</code> çŠ¶æ€ä¸Šè¿›è¡Œè‡ªæ—‹ï¼Œåˆ¤æ–­å®ƒèƒ½å¦è·å–åˆ°é”ã€‚</p><p>CLH é˜Ÿåˆ—é”çš„ç¼ºç‚¹æ˜¯å®ƒåœ¨æ— ç¼“å­˜çš„ NUMA æ¶æ„æœºå™¨ä¸Šæ€§èƒ½å¹¶ä¸å¥½ã€‚å› ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½è‡ªæ—‹åœ¨å¦ä¸€ä¸ªçº¿ç¨‹çš„ <code>QNode</code> çŠ¶æ€ä¸Šï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ <code>QNode</code> çŠ¶æ€å¯¹è±¡å¯èƒ½å­˜æ”¾åœ¨å¦ä¸€ä¸ª CPU çš„æœ¬åœ°å†…å­˜ä¸­ï¼Œè¿™å°†å¯¼è‡´è¿™ç§è‡ªæ—‹æ“ä½œå°†å˜å¾—å¾ˆæ…¢ã€‚å¦‚æœæ˜¯åœ¨ SMP æ¶æ„çš„æœºå™¨ä¸Šï¼Œå› ä¸ºå†…å­˜è¯»å–çš„å¼€é”€æ˜¯ç»Ÿä¸€çš„ï¼Œå› æ­¤è¯¥ç®—æ³•çš„æ€§èƒ½å°±å¾ˆå¥½ã€‚</p><blockquote><p>Perhaps the only disadvantage of this lock algorithm is that it performs poorly on cacheless NUMA architectures. Each thread spins waiting for its predecessorâ€™s nodeâ€™s <code>locked</code> ï¬eld to become <code>false</code>. If this memory location is remote, then performance suffers. On cache-coherent architectures, however, this approach should work well.</p></blockquote><h1 class=heading id=referece>Referece
<a class=anchor href=#referece>#</a></h1><ol><li>The Art of Multiprocessor Programming 7.5.2</li><li><a href=https://stackoverflow.com/questions/43628187/why-clh-lock-need-prev-node-in-java>multithreading - Why CLH Lock need prev-Node in java - Stack Overflow</a></li><li><a href=https://juejin.cn/post/6864210697292054541>AQSåŸºç¡€â€”â€”å¤šå›¾è¯¦è§£CLHé”çš„åŸç†ä¸å®ç° - æ˜é‡‘</a></li><li><a href=https://juejin.cn/post/6981431787746492447>ğŸ†ã€æ•°æ®ç»“æ„ä¹‹æ—…ã€‘ã€Œçº¿ç¨‹é”ç®—æ³•ä¸“é¡¹ã€å¼•é¢†ä½ èµ°è¿›CLHé˜Ÿåˆ—é”æœºåˆ¶åŸç†ä¸–ç•Œ - æ˜é‡‘</a></li><li><a href=https://gee.cs.oswego.edu/dl/papers/aqs.pdf>https://gee.cs.oswego.edu/dl/papers/aqs.pdf</a></li></ol></div></article><div class=single-comments><script src=https://giscus.app/client.js data-repo data-repo-id data-category data-category-id data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script></div><div class=single-pagination><hr><div class=flexnowrap><div class=single-pagination-prev><div class=single-pagination-container-prev><div class=single-pagination-text>â†</div><div class=single-pagination-text><a href=/archive/11_leetcode_note_5_search_in_rotated_sorted_array/>LeetCode ç¬”è®° 5ï¼šSearch in Rotated Sorted Array</a></div></div></div><div class=single-pagination-next><div class=single-pagination-container-next><div class=single-pagination-text><a href=/archive/13_aqs_intro/>AbstractQueuedSynchronizer ç®€ä»‹</a></div><div class=single-pagination-text>â†’</div></div></div></div><hr></div><div class=back-to-top><a href=#top>back to top</a></div></div></main></div><footer><p>Powered by
<a href=https://gohugo.io/>Hugo</a>
and
<a href=https://github.com/tomfran/typo>tomfran/typo</a></p></footer></body><script src=/js/theme-switch.js></script><script defer src=/js/copy-code.js></script></html>